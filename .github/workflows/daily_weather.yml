name: Daily Birchdale Weather & Lake Report

on:
  schedule:
    - cron: '0 13 * * *'  # 6 AM PST daily
  workflow_dispatch:

permissions:
  contents: write

jobs:
  send-report:
    runs-on: ubuntu-latest
    
    env:
      EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
      EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
      EMAIL_TO: ${{ secrets.EMAIL_TO }}
      TWILIO_SID: ${{ secrets.TWILIO_SID }}
      TWILIO_TOKEN: ${{ secrets.TWILIO_TOKEN }}
      TWILIO_PHONE: ${{ secrets.TWILIO_PHONE }}
      OPENWEATHER_API_KEY: ${{ secrets.OPENWEATHER_API_KEY }}
      LAKE_SPREADSHEET_ID: ${{ secrets.LAKE_SPREADSHEET_ID }}
      GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests twilio pytz beautifulsoup4 pandas matplotlib python-dateutil google-auth google-auth-oauthlib google-api-python-client
      
      - name: Setup Google Credentials
        run: |
          echo "$GOOGLE_CREDENTIALS_JSON" | base64 -d > credentials.json
      
      - name: Prepare public directory
        run: |
          mkdir -p public
          cp index.html public/index.html
      
      - name: Run lake monitoring script
        run: |
          echo "=== GENERATING FILES ==="
          python main.py
          echo "=== GENERATION COMPLETE ==="
      
      - name: Verify files exist
        run: |
          echo "=== VERIFYING FILES ==="
          ls -lh public/
          
          if [ -f public/lake_chart.png ]; then
            echo "✓ PNG exists: $(stat -c%s public/lake_chart.png 2>/dev/null || stat -f%z public/lake_chart.png) bytes"
          else
            echo "✗ PNG missing!"
            exit 1
          fi
          
          if [ -f public/lake.html ]; then
            echo "✓ HTML exists"
          else
            echo "✗ HTML missing!"
            exit 1
          fi
      
      - name: Single atomic commit
        run: |
          git config --global user.name "Weather & Lake Bot"
          git config --global user.email "weather-bot@github-actions"
          
          # Clean up credentials
          rm -f credentials.json
          
          echo "=== STAGING ALL FILES ATOMICALLY ==="
          
          # Stage ALL files in public/ at once
          git add public/index.html
          git add public/lake.html
          git add public/lake_chart.png
          
          # Verify everything is staged
          echo ""
          echo "=== STAGED FILES ==="
          git diff --cached --name-status
          
          # Count staged files
          STAGED_COUNT=$(git diff --cached --name-only | wc -l)
          echo ""
          echo "Files staged: $STAGED_COUNT"
          
          if [ "$STAGED_COUNT" -eq 0 ]; then
            echo "⚠ No changes to commit"
            exit 0
          fi
          
          # Single commit with ALL changes
          TIMESTAMP=$(date +'%Y-%m-%d %I:%M %p PST')
          
          echo ""
          echo "=== COMMITTING ==="
          git commit -m "Update lake data & chart - $TIMESTAMP [skip ci]"
          
          # Push once
          echo ""
          echo "=== PUSHING ==="
          git push
          
          echo ""
          echo "✓ Single atomic commit completed!"
          echo "✓ All files committed together - no race condition"
      
      - name: Summary
        if: always()
        run: |
          echo ""
          echo "========================================="
          echo "WORKFLOW COMPLETE"
          echo "========================================="
          echo "✓ Files generated"
          echo "✓ Single atomic commit (prevents Netlify race)"
          echo "✓ Netlify will deploy once with all files"
          echo "========================================="
